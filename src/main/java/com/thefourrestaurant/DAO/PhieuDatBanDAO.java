package com.thefourrestaurant.DAO;

import java.sql.*;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.math.BigDecimal;

import com.thefourrestaurant.connect.ConnectSQL;
import com.thefourrestaurant.model.*;

public class PhieuDatBanDAO {
    private KhachHangDAO khachHangDAO = new KhachHangDAO();
    private NhanVienDAO nhanVienDAO = new NhanVienDAO();
    private BanDAO banDAO = new BanDAO();

    // üîπ L·∫•y t·∫•t c·∫£ phi·∫øu ch∆∞a x√≥a
    public List<PhieuDatBan> layTatCaPhieu() {
        List<PhieuDatBan> danhSach = new ArrayList<>();
        String sql = "SELECT * FROM PhieuDatBan WHERE isDeleted = 0";

        try (Connection conn = ConnectSQL.getConnection();
             Statement st = conn.createStatement();
             ResultSet rs = st.executeQuery(sql)) {

            while (rs.next()) {
                PhieuDatBan pdb = new PhieuDatBan();
                pdb.setMaPDB(rs.getString("maPDB"));
                pdb.setNgayTao(rs.getTimestamp("ngayTao").toLocalDateTime());
                pdb.setNgayDat(rs.getTimestamp("ngayDat").toLocalDateTime());
                pdb.setSoNguoi(rs.getInt("soNguoi"));
                pdb.setKhachHang(khachHangDAO.layKhachHangTheoMa(rs.getString("maKH")));
                pdb.setNhanVien(nhanVienDAO.layNhanVienTheoMa(rs.getString("maNV")));
                pdb.setBan(banDAO.layTheoMa(rs.getString("maBan")));
                pdb.setTrangThai(rs.getString("trangThai"));
                pdb.setTienCoc(rs.getBigDecimal("tienCoc"));
                pdb.setDeleted(rs.getBoolean("isDeleted"));
                pdb.setChiTietPDB(new ChiTietPDBDAO().layTheoPhieu(rs.getString("maPDB")));

                danhSach.add(pdb);
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
        return danhSach;
    }

    // üîπ L·∫•y phi·∫øu theo m√£
    public PhieuDatBan layPhieuTheoMa(String maPDB) {
        String sql = "SELECT * FROM PhieuDatBan WHERE maPDB = ?";
        try (Connection conn = ConnectSQL.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setString(1, maPDB);
            ResultSet rs = ps.executeQuery();

            if (rs.next()) {
                PhieuDatBan pdb = new PhieuDatBan();
                pdb.setMaPDB(rs.getString("maPDB"));
                pdb.setNgayTao(rs.getTimestamp("ngayTao").toLocalDateTime());
                pdb.setNgayDat(rs.getTimestamp("ngayDat").toLocalDateTime());
                pdb.setSoNguoi(rs.getInt("soNguoi"));
                pdb.setKhachHang(khachHangDAO.layKhachHangTheoMa(rs.getString("maKH")));
                pdb.setNhanVien(nhanVienDAO.layNhanVienTheoMa(rs.getString("maNV")));
                pdb.setBan(banDAO.layTheoMa(rs.getString("maBan")));
                pdb.setTrangThai(rs.getString("trangThai"));
                pdb.setTienCoc(rs.getBigDecimal("tienCoc"));
                pdb.setDeleted(rs.getBoolean("isDeleted"));

                return pdb;
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }

    // üîπ Th√™m phi·∫øu m·ªõi (t·ª± ƒë·ªông l∆∞u ti·ªÅn c·ªçc n·∫øu l√† "ƒê·∫∑t tr∆∞·ªõc")
    public boolean themPhieu(PhieuDatBan pdb, String context) {
        String sql = "INSERT INTO PhieuDatBan (maPDB, ngayDat, soNguoi, maKH, maNV, maBan, trangThai, tienCoc) VALUES (?, ?, ?, ?, ?, ?, ?, ?)";

        try (Connection conn = ConnectSQL.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            String maMoi = taoMaPhieuMoi();
            pdb.setMaPDB(maMoi);

            String trangThaiMacDinh = "ƒêang ph·ª•c v·ª•";
            if ("DAT_TRUOC".equals(context)) {
                trangThaiMacDinh = "ƒê·∫∑t tr∆∞·ªõc";
            }
            String trangThaiThucTe = (pdb.getTrangThai() != null && !pdb.getTrangThai().isBlank())
                    ? pdb.getTrangThai()
                    : trangThaiMacDinh;

            BigDecimal tienCoc = BigDecimal.ZERO;
            try {
                if ("ƒê·∫∑t tr∆∞·ªõc".equals(trangThaiThucTe)) {
                    Ban ban = banDAO.layTheoMa(pdb.getBan().getMaBan());
                    if (ban != null && ban.getLoaiBan() != null && ban.getLoaiBan().getGiaTien() != null) {
                        tienCoc = ban.getLoaiBan().getGiaTien();
                    }
                }
            } catch (Exception ignore) {
                // Gi·ªØ tienCoc = 0 n·∫øu c√≥ l·ªói khi tra c·ª©u gi√°
            }

            ps.setString(1, maMoi);
            ps.setTimestamp(2, Timestamp.valueOf(pdb.getNgayDat() != null ? pdb.getNgayDat() : LocalDateTime.now()));
            ps.setInt(3, pdb.getSoNguoi());
            ps.setString(4, pdb.getKhachHang().getMaKH());
            ps.setString(5, pdb.getNhanVien().getMaNV());
            ps.setString(6, pdb.getBan().getMaBan());
            ps.setString(7, trangThaiThucTe);
            ps.setBigDecimal(8, tienCoc);
            
            return ps.executeUpdate() > 0;

        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }
    
 // X√≥a phi·∫øu (x√≥a logic, set isDeleted = 1)
    public boolean xoaPhieu(String maPDB) {
        String sql = "UPDATE PhieuDatBan SET isDeleted = 1 WHERE maPDB = ?";
        try (Connection conn = ConnectSQL.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setString(1, maPDB);
            return ps.executeUpdate() > 0;

        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }

    // üîπ T·∫°o m√£ phi·∫øu m·ªõi
    public String taoMaPhieuMoi() {
        String sql = "SELECT TOP 1 maPDB FROM PhieuDatBan ORDER BY maPDB DESC";
        try (Connection conn = ConnectSQL.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql);
             ResultSet rs = ps.executeQuery()) {

            if (rs.next()) {
                String lastId = rs.getString("maPDB");
                int number = Integer.parseInt(lastId.substring(2)) + 1;
                return String.format("PD%06d", number);
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
        return "PD000001";
    }
    
 // Trong PhieuDatBanDAO
	public PhieuDatBan layPhieuDangHoatDongTheoBan(String maBan) {
	    String sql = "SELECT * FROM PhieuDatBan WHERE maBan = ? AND trangThai = N'ƒêang ph·ª•c v·ª•' AND isDeleted = 0";
	    try (Connection conn = ConnectSQL.getConnection();
	         PreparedStatement ps = conn.prepareStatement(sql)) {
	
	        ps.setString(1, maBan);
	        ResultSet rs = ps.executeQuery();
	
	        if (rs.next()) {
	            PhieuDatBan pdb = new PhieuDatBan();
	            pdb.setMaPDB(rs.getString("maPDB"));
	            pdb.setNgayTao(rs.getTimestamp("ngayTao").toLocalDateTime());
	            pdb.setNgayDat(rs.getTimestamp("ngayDat").toLocalDateTime());
	            pdb.setSoNguoi(rs.getInt("soNguoi"));
	            pdb.setKhachHang(new KhachHangDAO().layKhachHangTheoMa(rs.getString("maKH")));
	            pdb.setNhanVien(new NhanVienDAO().layNhanVienTheoMa(rs.getString("maNV")));
	            pdb.setBan(new BanDAO().layTheoMa(rs.getString("maBan")));
	            pdb.setTrangThai(rs.getString("trangThai"));
                pdb.setTienCoc(rs.getBigDecimal("tienCoc"));
	            pdb.setDeleted(rs.getBoolean("isDeleted"));
	
	            ChiTietPDBDAO chiTietPDBDAO = new ChiTietPDBDAO();
	            pdb.setChiTietPDB(chiTietPDBDAO.layTheoPhieu(pdb.getMaPDB()));
	
	            return pdb;
	        }
	
	    } catch (Exception e) {
	        e.printStackTrace();
	    }
	    return null;
	}

    public List<PhieuDatBan> layDanhSachPhieuDatTruocTheoBan(String maBan) {
        List<PhieuDatBan> danhSach = new ArrayList<>();
        String sql = """
	            SELECT * FROM PhieuDatBan
	            WHERE maBan = ? AND trangThai = N'ƒê·∫∑t tr∆∞·ªõc' AND isDeleted = 0
	            """;

        try (Connection con = ConnectSQL.getConnection();
             PreparedStatement ps = con.prepareStatement(sql)) {

            ps.setString(1, maBan);
            ResultSet rs = ps.executeQuery();

            while (rs.next()) {
                PhieuDatBan pdb = new PhieuDatBan();
                pdb.setMaPDB(rs.getString("maPDB"));
                pdb.setNgayTao(rs.getTimestamp("ngayTao").toLocalDateTime());
                pdb.setNgayDat(rs.getTimestamp("ngayDat").toLocalDateTime());
                pdb.setSoNguoi(rs.getInt("soNguoi"));
                pdb.setKhachHang(new KhachHangDAO().layKhachHangTheoMa(rs.getString("maKH")));
                pdb.setNhanVien(new NhanVienDAO().layNhanVienTheoMa(rs.getString("maNV")));
                pdb.setBan(new BanDAO().layTheoMa(rs.getString("maBan")));
                pdb.setTrangThai(rs.getString("trangThai"));
                pdb.setTienCoc(rs.getBigDecimal("tienCoc"));
                pdb.setDeleted(rs.getBoolean("isDeleted"));
                pdb.setChiTietPDB(new ChiTietPDBDAO().layTheoPhieu(pdb.getMaPDB()));

                danhSach.add(pdb);
            }

        } catch (Exception e) {
            e.printStackTrace();
        }

        return danhSach;
    }

	public boolean huyPhieuDatBan(String maPDB) {
	    String sql = """
	            UPDATE PhieuDatBan
	            SET trangThai = N'ƒê√£ h·ªßy'
	            WHERE maPDB = ? AND isDeleted = 0
	            """;
	    try (Connection con = ConnectSQL.getConnection();
	         PreparedStatement ps = con.prepareStatement(sql)) {
	        ps.setString(1, maPDB);
	        return ps.executeUpdate() > 0;
	    } catch (Exception e) {
	        e.printStackTrace();
	    }
	    return false;
	}

    public boolean capNhatTrangThai(String maPDB, String trangThaiMoi) {
        // N·∫øu c·∫≠p nh·∫≠t sang "ƒê·∫∑t tr∆∞·ªõc" th√¨ t·ª± ƒë·ªông g√°n ti·ªÅn c·ªçc = gi√° lo·∫°i b√†n
        String sqlDatTruoc = """
                UPDATE PhieuDatBan
                SET trangThai = ?,
                    tienCoc = (SELECT lb.giaTien
                               FROM PhieuDatBan pdb
                               JOIN Ban b ON pdb.maBan = b.maBan
                               JOIN LoaiBan lb ON b.maLoaiBan = lb.maLoaiBan
                               WHERE pdb.maPDB = ?)
                WHERE maPDB = ?
                """;
        String sqlKhac = "UPDATE PhieuDatBan SET trangThai = ? WHERE maPDB = ?";

        try (Connection conn = ConnectSQL.getConnection()) {
            if ("ƒê·∫∑t tr∆∞·ªõc".equals(trangThaiMoi)) {
                try (PreparedStatement ps = conn.prepareStatement(sqlDatTruoc)) {
                    ps.setString(1, trangThaiMoi);
                    ps.setString(2, maPDB);
                    ps.setString(3, maPDB);
                    return ps.executeUpdate() > 0;
                }
            } else {
                try (PreparedStatement ps = conn.prepareStatement(sqlKhac)) {
                    ps.setString(1, trangThaiMoi);
                    ps.setString(2, maPDB);
                    return ps.executeUpdate() > 0;
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        }
    }
    
 // üîπ L·∫•y phi·∫øu ƒë·∫∑t tr∆∞·ªõc g·∫ßn nh·∫•t theo m√£ b√†n
    public PhieuDatBan layPhieuDatTruocTheoBan(String maBan) {
        String sql = """
            SELECT TOP 1 * FROM PhieuDatBan
            WHERE maBan = ? AND trangThai = N'ƒê·∫∑t tr∆∞·ªõc' AND isDeleted = 0
            ORDER BY ngayDat DESC
            """;
        try (Connection con = ConnectSQL.getConnection();
             PreparedStatement ps = con.prepareStatement(sql)) {

            ps.setString(1, maBan);
            ResultSet rs = ps.executeQuery();

            if (rs.next()) {
                PhieuDatBan pdb = new PhieuDatBan();
                pdb.setMaPDB(rs.getString("maPDB"));
                pdb.setNgayTao(rs.getTimestamp("ngayTao").toLocalDateTime());
                pdb.setNgayDat(rs.getTimestamp("ngayDat").toLocalDateTime());
                pdb.setSoNguoi(rs.getInt("soNguoi"));
                pdb.setKhachHang(new KhachHangDAO().layKhachHangTheoMa(rs.getString("maKH")));
                pdb.setNhanVien(new NhanVienDAO().layNhanVienTheoMa(rs.getString("maNV")));
                pdb.setBan(new BanDAO().layTheoMa(rs.getString("maBan")));
                pdb.setTrangThai(rs.getString("trangThai"));
                pdb.setTienCoc(rs.getBigDecimal("tienCoc"));
                pdb.setDeleted(rs.getBoolean("isDeleted"));
                pdb.setChiTietPDB(new ChiTietPDBDAO().layTheoPhieu(pdb.getMaPDB()));
                return pdb;
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }
}
